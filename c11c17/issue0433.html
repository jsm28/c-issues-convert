<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>C issue 0433: Issue with constraints for wide character function arguments involving RSIZE_MAX</title>
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.hll { background-color: #ffffcc }
.c { color: #3D7B7B; font-style: italic } /* Comment */
.err { border: 1px solid #FF0000 } /* Error */
.k { color: #008000; font-weight: bold } /* Keyword */
.o { color: #666666 } /* Operator */
.ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.cp { color: #9C6500 } /* Comment.Preproc */
.cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.gd { color: #A00000 } /* Generic.Deleted */
.ge { font-style: italic } /* Generic.Emph */
.ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.gr { color: #E40000 } /* Generic.Error */
.gh { color: #000080; font-weight: bold } /* Generic.Heading */
.gi { color: #008400 } /* Generic.Inserted */
.go { color: #717171 } /* Generic.Output */
.gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.gs { font-weight: bold } /* Generic.Strong */
.gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.gt { color: #0044DD } /* Generic.Traceback */
.kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.kp { color: #008000 } /* Keyword.Pseudo */
.kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.kt { color: #B00040 } /* Keyword.Type */
.m { color: #666666 } /* Literal.Number */
.s { color: #BA2121 } /* Literal.String */
.na { color: #687822 } /* Name.Attribute */
.nb { color: #008000 } /* Name.Builtin */
.nc { color: #0000FF; font-weight: bold } /* Name.Class */
.no { color: #880000 } /* Name.Constant */
.nd { color: #AA22FF } /* Name.Decorator */
.ni { color: #717171; font-weight: bold } /* Name.Entity */
.ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.nf { color: #0000FF } /* Name.Function */
.nl { color: #767600 } /* Name.Label */
.nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.nt { color: #008000; font-weight: bold } /* Name.Tag */
.nv { color: #19177C } /* Name.Variable */
.ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.w { color: #bbbbbb } /* Text.Whitespace */
.mb { color: #666666 } /* Literal.Number.Bin */
.mf { color: #666666 } /* Literal.Number.Float */
.mh { color: #666666 } /* Literal.Number.Hex */
.mi { color: #666666 } /* Literal.Number.Integer */
.mo { color: #666666 } /* Literal.Number.Oct */
.sa { color: #BA2121 } /* Literal.String.Affix */
.sb { color: #BA2121 } /* Literal.String.Backtick */
.sc { color: #BA2121 } /* Literal.String.Char */
.dl { color: #BA2121 } /* Literal.String.Delimiter */
.sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.s2 { color: #BA2121 } /* Literal.String.Double */
.se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.sh { color: #BA2121 } /* Literal.String.Heredoc */
.si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.sx { color: #008000 } /* Literal.String.Other */
.sr { color: #A45A77 } /* Literal.String.Regex */
.s1 { color: #BA2121 } /* Literal.String.Single */
.ss { color: #19177C } /* Literal.String.Symbol */
.bp { color: #008000 } /* Name.Builtin.Pseudo */
.fm { color: #0000FF } /* Name.Function.Magic */
.vc { color: #19177C } /* Name.Variable.Class */
.vg { color: #19177C } /* Name.Variable.Global */
.vi { color: #19177C } /* Name.Variable.Instance */
.vm { color: #19177C } /* Name.Variable.Magic */
.il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body>
<h2>Issue 0433: Issue with constraints for wide character function arguments involving <strong>RSIZE_MAX</strong></h2>
<p><strong>This issue has been automatically converted from the original issue lists and some formatting may not have been preserved.</strong></p>
<p>Authors: WG 14, Douglas Walls<br />
Date: 2013-03-12<br />
Reference document: <a href="https://www.open-std.org/jtc1/sc22/wg14/www/docs/n1683.htm">N1683</a> <a href="https://www.open-std.org/jtc1/sc22/wg14/www/docs/n1771.htm">N1771</a><br />
Submitted against: C11 / C17<br />
Status: Fixed<br />
Fixed in: C17<br />
Cross-references: <a href="../c11c17/issue0428.html">0428</a><br />
Converted from: <a href="https://www.open-std.org/jtc1/sc22/wg14/www/docs/n2396.htm">n2396.htm</a></p>
<h3>Summary</h3>
<p><strong>K.3.7.2.2 The strncat_s function</strong><br />
The <strong>strncat_s()</strong> has a constraint that neither <strong>s1max</strong> nor <strong>n</strong> shall be
greater than <strong>RSIZE_MAX.</strong><br />
Both s1max and n are defined as representing a number of char sized characters.</p>
<p><strong>K.3.9.2.1.2 The wcsncpy_s function</strong><br />
The same constraint is given for the function the <strong>wcsncat_s()</strong> function,
i.e. that neither <strong>s1max</strong> nor <strong>n</strong> shall be greater than <strong>RSIZE_MAX</strong>.  For
<strong>wcsncat_s(), s1max</strong> and <strong>n</strong> are defined as representing a number of
<strong>wchar_t</strong> sized characters.  On most implementations the size of a wide
characters is many times the size of a char.  On Solaris it is 4 time the size.</p>
<p><strong>K.3.4 Integer types &lt;stdint.h&gt;</strong> is defined as follows<br />
1 The header <strong>&lt;stdint.h&gt;</strong> defines a macro.<br />
2 The macro is</p>
<p><strong>RSIZE_MAX</strong></p>
<p>which expands to a value 386) of type <strong>size_t</strong>. Functions that have
parameters of type <strong>rsize_t</strong> consider it a runtime-constraint violation if
the values of those parameters are greater than <strong>RSIZE_MAX</strong>.</p>
<p>386) The macro <strong>RSIZE_MAX</strong> need not expand to a constant expression.</p>
<p><strong>Recommended practice</strong></p>
<p>3 Extremely large object sizes are frequently a sign that an object's size was
calculated incorrectly. For example, negative numbers appear as very large
positive numbers when converted to an unsigned type like size_t. Also, some
implementations do not support objects as large as the maximum value that can be
represented by type size_t.</p>
<p>4 For those reasons, it is sometimes beneficial to restrict the range of object
sizes to detect programming errors. For implementations targeting machines with
large address spaces, it is recommended that <strong>RSIZE_MAX</strong> be defined as the
smaller of the size of the largest object supported or <strong>(SIZE_MAX &gt;&gt; 1)</strong>,
even if this limit is smaller than the size of some legitimate, but very large,
objects. Implementations targeting machines with small address spaces may wish
to define <strong>RSIZE_MAX</strong> as <strong>SIZE_MAX</strong>, which means that there is no object
size that is considered a runtime-constraint violation.</p>
<hr />
<p>The recommended practice implies <strong>RSIZE_MAX</strong> represents maximum object sizes.</p>
<p>Footnote 386) implies an implementation can adjust what <strong>RSIZE_MAX</strong> expands
to depending upon the context in which it is being used.  But what I don't
understand is how, the user can take advantage of <strong>RSIZE_MAX</strong> to check the
values of n and s1max prior to calling the function <strong>wcsncpy_s</strong> in order to
avoid violating the runtime constraint error.  There is no context in which the
implementation can expand <strong>RSIZE_MAX</strong> to the value they need.</p>
<p>Example:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>((s1max<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span>RSIZE_MAX)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span><span style="color: #bbbbbb"> </span>(n<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;=</span><span style="color: #bbbbbb"> </span>RSIZE_MAX))
<span style="color: #bbbbbb">     </span>error<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>wcsncpy_s<span style="color: #bbbbbb"> </span>(s1,<span style="color: #bbbbbb"> </span>s1max,<span style="color: #bbbbbb"> </span>s2<span style="color: #bbbbbb"> </span>n);<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// Assume no other runtime constraints</span>
<span style="color: #bbbbbb">     </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(error<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>)<span style="color: #bbbbbb"> </span>{
<span style="color: #bbbbbb">        </span><span style="color: #3D7B7B; font-style: italic">// Since RSIZE_MAX is not a constant expression</span>
<span style="color: #bbbbbb">        </span><span style="color: #3D7B7B; font-style: italic">// Can this ever occur due to s1max or n being greater than RSIZE_MAX?</span>
<span style="color: #bbbbbb">     </span>}
<span style="color: #bbbbbb">  </span>}
</pre></div>

<p>Is a conforming implementation allowed  to return a non-zero value for
<strong>wcsncpy_s()</strong> in the example above?</p>
<p>N1147 the Rationale for TR24731 explains implementations might wish to adjust
the value of <strong>RSIZE_MAX</strong> dynamically, and gives several scenarios for doing
so. None of which seem germane to the questions raised here.</p>
<hr />
<p>So what is the purpose of providing the macro <strong>RSIZE_MAX</strong>?<br />
If the purpose is to limit all buffer sizes to <strong>RSIZE_MAX</strong>, it's use in
constraints for wide character functions appear to be malformed.</p>
<p>The definitions of <strong>wcsncpy_s()</strong> and <strong>strncat_s()</strong> have constraints that
treat their arguments that represent character counts as if those counts
represent the size of an object that can be tested against <strong>RSIZE_MAX</strong> in the
same way.  But those character counts represent characters of very different
sizes.  And thus very different object sizes.  Maybe the constraint error for
<strong>wcsncpy_s()</strong> arguments <strong>smax1</strong> and <strong>n</strong> should be rewritten as something
like:</p>
<p>Neither <strong>(s1max * sizeof(wchar_t))</strong> nor <strong>(n * sizeof(wchar_t))</strong> shall
be greater than <strong>RSIZE_MAX</strong>.</p>
<p>Other functions where max argument represent the number of<br />
wchar_t or multi-byte characters and may need similar changes<br />
include:</p>
<p><strong>mbstowcs_s<br />
wcstombs_s<br />
snwprintf_s<br />
swprintf_s<br />
swscanf_s<br />
vsnwprintf_s<br />
vswprintf_s<br />
wcscpy_s<br />
wcsncpy_s<br />
wmemcpy_s<br />
wmemmove_s<br />
wcscat_s<br />
wcstok_s<br />
wcrtomb_s<br />
mbsrtowcs_s<br />
wcsrtombs_s</strong></p>
<h3>Suggested Technical Corrigendum</h3>
<hr />
<p>Comment from WG14 on 2017-11-03:</p>
<p>Apr 2013 meeting</p>
<h3>Committee Discussion</h3>
<ul>
<li>RSIZE_MAX is intended to be the maximum size, in bytes, permitted by an implementation for an object.</li>
<li>The constraints for wide character functions appear to be incorrect.</li>
<li>For example, K.3.9.2.1.2p8 second sentence should read something like "Neither s1max*sizeof(wchar_t) nor n*sizeof(wchar_t) shall be greater than RSIZE_MAX."</li>
</ul>
<p>Oct 2013 meeting</p>
<h3>Committee Discussion</h3>
<ul>
<li>The list of functions cited was not entirely correct, and upon further review the Suggested Technical Corrigendum from <a href="https://www.open-std.org/jtc1/sc22/wg14/www/docs/n1771.htm">N1771</a> were adopted.</li>
<li>These changes also address, where noted, the defect reported in <a href="../c11c17/issue0428.html">DR428.</a></li>
</ul>
<p>Apr 2014 meeting</p>
<h3>Committee Discussion</h3>
<blockquote>
<p>A "nor nor" typo in the Suggested Technical Corrigendum for K.3.9.3.2.2p12 was
noticed and corrected in the Proposed Technical Corrigendum below.</p>
</blockquote>
<h3>Proposed Technical Corrigendum</h3>
<p>K.3.6.5.1 The mbstowcs_s function</p>
<p>In K.3.6.5.1p2, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.6.5.1p3, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.6.5.2 The wcstombs_s function</p>
<p>In K.3.6.5.2p2, replace "then neither len nor dstmax shall be greater than
RSIZE_MAX" with<br />
"then neither len shall be greater than RSIZE_MAX/sizeof(wchar_t) nor dstmax
shall be greater than RSIZE_MAX".<br />
In K.3.6.5.2p3, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX".</p>
<p>K.3.9.1.3 The snwprintf_s function</p>
<p>In K.3.9.1.3p2, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.1.3p3, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX/sizeof(wchar_t)".  See DR 428</p>
<p>K.3.9.1.4 The swprintf_s function</p>
<p>In K.3.9.1.4p2, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.1.4p3, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX/sizeof(wchar_t)".  See DR 428</p>
<p>K.3.9.1.8 The vsnwprintf_s function</p>
<p>In K.3.9.1.8p2, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.1.8p3, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX/sizeof(wchar_t)".  See DR 428</p>
<p>K.3.9.1.9 The vswprintf_s function</p>
<p>In K.3.9.1.9p2, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.1.9p3, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX/sizeof(wchar_t)".  See DR 428</p>
<p>K.3.9.2.1.1 The wcscpy_s function</p>
<p>In K.3.9.2.1.1p2, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.2.1.1p3, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.9.2.1.2 The wcsncpy_s function</p>
<p>In K.3.9.2.1.2p8, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.2.1.2p9, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.9.2.1.3 The wmemcpy_s function</p>
<p>In K.3.9.2.1.3p15, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.2.1.3p16, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.9.2.1.4 The wmemmove_s function</p>
<p>In K.3.9.2.1.4p20, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.2.1.4p21, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.9.2.2.1 The wcscat_s function</p>
<p>In K.3.9.2.2.1p3, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.2.2.1p4, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.9.2.2.2 The wcsncat_s function</p>
<p>In K.3.9.2.2.2p10, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.2.2.2p11, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.9.2.3.1 The wcstok_s function</p>
<p>In K.3.9.2.3.1p2, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".</p>
<p>K.3.9.3.2.1 The mbsrtowcs_s function</p>
<p>In K.3.9.3.2.1p3, replace "RSIZE_MAX" with "RSIZE_MAX/sizeof(wchar_t)".<br />
In K.3.9.3.2.1p4, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX/sizeof(wchar_t)".  See DR 428</p>
<p>K.3.9.3.2.2 The wcsrtombs_s function</p>
<p>In K.3.9.3.2.2p12, replace "then neither len nor dstmax shall be greater than
RSIZE_MAX" with<br />
"then neither len shall be greater than RSIZE_MAX/sizeof(whcar_t) nor dstmax
shall be greater than RSIZE_MAX".<br />
In K.3.9.3.2.2p13, replace "less than RSIZE_MAX" with "not greater than
RSIZE_MAX".</p>

</body>
</html>
